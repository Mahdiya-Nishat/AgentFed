import matplotlib.pyplot as plt
import numpy as np

def simulate_multi_drift_performance(epochs=300):
    
    time = np.arange(epochs)
    drift_points = [60, 140, 220] # Multiple points where the environment changes
    
    
    standalone_acc = np.zeros(epochs)
    agentfed_acc = np.zeros(epochs)
    
    
    s_val = 0.94 
    a_val = 0.94
    
    for t in range(epochs):
        noise = np.random.normal(0, 0.008)
        
        # Check if we hit a drift event
        if t in drift_points:
            # Sudden drop due to environment change
            s_val -= 0.12  
            a_val -= 0.08  
        
        # Standalone Logic: Passive recovery only 
        s_val = min(0.95, s_val + 0.001 + noise)
        
        # AgentFed Logic
        # We simulate the Supervisor LLM detecting drift and pushing KD 10 epochs later
        is_recovering = False
        for dp in drift_points:
            if dp < t < dp + 25: # The KD intervention window
                a_val += 0.012 # Sharp correction from Supervisor
                is_recovering = True
        
        if not is_recovering:
            a_val = min(0.96, a_val + 0.002 + noise)
            
        standalone_acc[t] = max(0.4, s_val) # Clamp at 0.4 for realism
        agentfed_acc[t] = min(0.97, a_val)

    return time, standalone_acc, agentfed_acc, drift_points

#Simulation
time, s_acc, a_acc, drifts = simulate_multi_drift_performance()

# Plotting the "Resilience" Phenomenon
plt.figure(figsize=(12, 6))
plt.plot(time, s_acc, label='Standalone SLM (Static Reasoning)', color='gray', linestyle='--', alpha=0.7)
plt.plot(time, a_acc, label='AgentFed (Agentic Communication)', color='#d62728', linewidth=2.5)

# Drift Events
for i, dp in enumerate(drifts):
    plt.axvline(x=dp, color='orange', linestyle=':', alpha=0.6)
    plt.text(dp, 0.45, f'Drift {i+1}', rotation=90, verticalalignment='bottom', fontweight='bold')

plt.title("Resilience Analysis: Multi-Event Semantic Drift Mitigation", fontsize=14)
plt.xlabel("Simulation Time (Epochs)")
plt.ylabel("Intent Execution Accuracy")
plt.grid(axis='y', alpha=0.2)
plt.legend(loc='lower left', frameon=True)
plt.ylim(0.4, 1.0)

plt.fill_between(time, s_acc, a_acc, where=(a_acc > s_acc), color='green', alpha=0.1, label='AgentFed Advantage')
plt.tight_layout()
plt.show()
